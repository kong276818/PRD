# PRD# PRD: RECAST+ (Advanced Query Rewriting with Dual-CLS & Windowing)

### 1. 문서 정보

| 항목 | 내용 |
| --- | --- |
| **문서명** | RECAST+: Dual-CLS 토큰 및 윈도우 기반의 고도화된 쿼리 재작성 프레임워크 |
| **작성자** | Gemini (사용자 아이디어 기반) |
| **버전** | 1.0 |
| **최종 수정일** | 2025년 6월 10일 |

### 2. 개요 (Introduction)

#### 2.1. 문제 정의 (Problem Statement)

최신 RAG(Retrieval-Augmented Generation) 시스템은 쿼리 재작성(Query Rewriting)을 통해 성능을 향상시키지만, 다음과 같은 한계에 직면해 있습니다.

* **모호하고 비정형적인 쿼리:** 사용자의 쿼리는 종종 노이즈가 많고 문법적으로 불완전하여 정확한 의도 파악이 어렵습니다.
* **장문(Long-context) 인식률 저하:** 특히 사용자가 긴 문장이나 단락 전체를 입력으로 제공할 경우, 기존 모델(단일 CLS 토큰 사용)은 입력의 핵심 의미와 구조적 의도를 모두 포착하는 데 어려움을 겪습니다. 이로 인해 문맥과 동떨어지거나 핵심을 놓치는 검색 결과 및 답변을 생성하게 됩니다.
* **피드백 의존성:** 기존 RL 기반 재작성 모델은 정답 데이터나 수동으로 설계된 보상 함수에 크게 의존하여 일반화 성능이 제한됩니다.

#### 2.2. 제안 솔루션 (Proposed Solution)

본 문서는 이러한 문제를 해결하기 위해 **RECAST+** 프레임워크를 제안합니다. RECAST+는 기존 RECAST의 '의미-의도 분리' 개념을 아키텍처 수준에서 강화한 모델입니다.

핵심은 **Dual-CLS 토큰 아키텍처**와 **슬라이딩 윈도우(Sliding Window) 메커니즘**을 도입하여, 특히 **장문의 복잡한 쿼리**에 대한 이해도를 획기적으로 높이는 것입니다. 모델은 입력 쿼리에서 의미적 내용(Semantic Content)과 구조적 의도(Intent Structure)를 각각 별도의 CLS 토큰으로 인코딩하고, 이를 종합하여 가장 정확한 **'브릿지 쿼리(Bridge Query)'**를 생성합니다.

### 3. 목표 (Goals & Objectives)

* **목표 1:** 장문(512 토큰 이상) 쿼리에 대한 재작성 정확도 20% 이상 향상
* **목표 2:** 모호하거나 비정형적인 쿼리에 대한 의도 파악 성공률 15% 이상 개선
* **목표 3:** 최종 RAG 시스템의 검색 정확도(nDCG@10 기준) 10% 이상 향상
* **목표 4:** 재작성 과정에서 수동 피드백 루프 의존도 감소

### 4. 기능 요구사항 (Features & Requirements)

#### 4.1. **핵심 기능 1: Dual-CLS 토큰 아키텍처**
* **설명:** 입력 시퀀스의 시작 부분에 두 종류의 CLS 토큰을 배치합니다.
    * **Semantic CLS ($CLS_S$):** 입력 텍스트의 전체적인 의미론적 내용을 압축하는 역할을 담당합니다. "무엇에 대한 내용인가?"에 집중합니다.
    * **Intent CLS ($CLS_I$):** 질문의 구조, 명령어, 비교, 요약 등 사용자의 구조적/행동적 의도를 포착하는 역할을 담당합니다. "무엇을 하길 원하는가?"에 집중합니다.
* **요구사항:**
    * 사전 학습된 언어 모델(예: BERT, RoBERTa)의 입력 임베딩 단계에서 $CLS_S$와 $CLS_I$ 토큰을 추가할 수 있어야 합니다.
    * 두 CLS 토큰은 서로 다른 방식으로 Attention을 받도록 초기화되거나, 학습 과정에서 역할이 자연스럽게 분화되도록 설계되어야 합니다.

#### 4.2. **핵심 기능 2: 슬라이딩 윈도우 및 토큰 연결 메커니즘**
* **설명:** 긴 입력이 들어왔을 때, 이를 고정된 크기(예: 256 토큰)의 윈도우(Window)로 분할하여 처리합니다. 각 윈도우는 일부 겹치는 부분(Overlap)을 가집니다.
    1.  각 윈도우는 독립적으로 Dual-CLS 토큰을 포함하여 인코딩됩니다.
    2.  모든 윈도우에서 처리된 $CLS_S$ 토큰들과 $CLS_I$ 토큰들은 별도의 시퀀스로 그룹화됩니다.
    3.  최종적으로 그룹화된 CLS 토큰 시퀀스에 추가적인 Transformer 레이어(또는 Attention 메커니즘)를 적용하여 **전체 문맥을 아우르는 최종 $CLS_{S_{final}}$ 와 $CLS_{I_{final}}$** 를 추출합니다. 이를 '토큰 연결'이라 칭합니다.
* **요구사항:**
    * 윈도우 크기(Window Size)와 겹침 크기(Overlap Size)를 조절할 수 있는 파라미터를 제공해야 합니다.
    * 각 윈도우에서 나온 CLS 토큰들을 효과적으로 융합(Fusion)하는 메커니즘(예: Gated Fusion, Cross-Attention)을 구현해야 합니다.

#### 4.3. **핵심 기능 3: 브릿지 쿼리 생성**
* **설명:** '토큰 연결' 단계에서 생성된 최종 $CLS_{S_{final}}$ 와 $CLS_{I_{final}}$ 임베딩을 Decoder 또는 생성 모델의 입력으로 사용하여, 원본 쿼리의 의미와 의도를 모두 명확하게 반영하는 새로운 '브릿지 쿼리'를 생성합니다.
* **요구사항:**
    * 최종 CLS 임베딩을 조건으로 쿼리를 생성하는 Sequence-to-Sequence 아키텍처를 구현해야 합니다.
    * 생성된 브릿지 쿼리는 검색 시스템(Retriever)과 답변 생성 모델(Generator) 모두에 더 효율적인 입력으로 사용될 수 있어야 합니다.
    * **수학적 표현:**
        $Q_{bridge} = \text{Decoder}(f(CLS_{S_{final}}, CLS_{I_{final}}))$

### 5. 사용자 시나리오 (Use Cases)

* **시나리오 1: 긴 보고서 요약 및 질문**
    * **사용자 입력:** (긴 분기 보고서 텍스트)... "이 보고서에서 언급된 3분기 주요 리스크와 전분기 대비 매출 성장률의 상관관계를 분석해줘."
    * **RECAST+ 동작:**
        1.  슬라이딩 윈도우로 보고서 전체를 스캔.
        2.  $CLS_S$ 토큰들은 '3분기 리스크', '매출 성장률' 등 의미적 핵심을 포착.
        3.  $CLS_I$ 토큰들은 '상관관계 분석', '비교'라는 구조적 의도를 포착.
        4.  **브릿지 쿼리 생성:** "3분기 재무 리스크와 매출 성장률 비교 분석"
* **시나리오 2: 모호한 법률 조항 해석**
    * **사용자 입력:** "개인정보보호법 제 3자 제공 동의 예외 조항 중에서 '정보 주체 또는 제3자의 이익을 부당하게 침해할 우려가 있을 때를 제외하고' 부분의 구체적인 판례가 궁금해."
    * **RECAST+ 동작:**
        1.  $CLS_S$는 '개인정보보호법', '3자 제공 동의 예외' 등을 포착.
        2.  $CLS_I$는 "A 중에서 B 부분의 구체적인 판례"라는 질의 구조를 명확히 포착.
        3.  **브릿지 쿼리 생성:** "개인정보보호법 제3자 제공 동의 예외 조항 관련 판례 검색"

### 6. 비기능적 요구사항 (Non-Functional Requirements)

* **성능 (Performance):** 쿼리 재작성 과정은 실시간 상호작용을 위해 500ms 이내에 완료되어야 합니다.
* **확장성 (Scalability):** 향후 더 큰 언어 모델(LLM)을 백본(Backbone)으로 교체할 수 있는 모듈식 구조여야 합니다.
* **의존성 (Dependencies):** PyTorch, Transformers 라이브러리를 기반으로 개발합니다. Faiss, Elasticsearch 등 표준적인 검색 라이브러리와 호환되어야 합니다.

### 7. 성공 지표 (Success Metrics)

* **정량적 지표:**
    * **재작성 성능:** ROUGE, BLEU, BERTScore (원본 쿼리 vs. 브릿지 쿼리 vs. 이상적 쿼리)
    * **검색 성능:** nDCG@k, Recall@k
    * **QA 성능:** Exact Match (EM), F1 Score
* **정성적 지표:**
    * A/B 테스트를 통한 사용자 만족도 조사
    * 재작성된 쿼리가 원본의 의도를 얼마나 잘 보존하고 명확하게 만드는지에 대한 전문가 평가

### 8. 범위 외 (Out of Scope)

* 본 프로젝트는 '쿼리 재작성 모델(RECAST+)' 개발에 집중하며, RAG 시스템의 검색기(Retriever)나 생성기(Generator) 자체를 새로 개발하지는 않습니다.
* 사용자 인터페이스(UI/UX) 개발은 포함하지 않습니다.
